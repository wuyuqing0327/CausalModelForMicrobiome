---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](https://urldefense.com/v3/__http://rmarkdown.rstudio.com__;!!MvNZe7V6M35iZPhbgng-hfU!xJwnDm359BvZPGhk_3qKswGnCVXN3oNbR-PFDO0XIQ-znR8Ippx0q-m_2mTxzoapE3jLKilXAPAWMybUwXlADFGOg6tV$ ) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
#### For Blood Pressure
library(CMAverse)
library(data.table)

# Load data
data <- fread('D:/My postdoc/COMPASS microbiome/causalmediate_blood.csv')
data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

data$NEWASV217[is.na(data$NEWASV217)] <- 0
data$NEWASV218[is.na(data$NEWASV218)] <- 0

names(data) <- gsub(pattern = "\\(", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\)", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\[", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\]", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\,", replacement = "_", x = names(data))
names(data) <- gsub(pattern = " ", replacement = "", x = names(data))

savecols <- c("specimen_id", "age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf", "bmi_missing",'M18','M12','M6','M24', "smoking_status_current", "smoking_status_former", "smoking_status_missing",
"diabetes2_No", "diabetes2_Yes", "diabetes2_Missing",
"HBP", "NEWASV217", "NEWASV218")
#write.csv(data[, ..savecols], #"/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/Datasets/causalmediate_blood_.csv", row.names = FALSE)



# Define the columns to keep
cols <- c( "age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf", "bmi_missing",'M12',
           "smoking_status_current", "smoking_status_former", "smoking_status_missing",
            "diabetes2_No", "diabetes2_Yes", "diabetes2_Missing",
             "HBP", "M18", "M24", "M6",
            "NEWASV217", "NEWASV218")
# Subset the data to include only these columns
df <- data[, ..cols]

data_dimensions <- dim(df)
print(data_dimensions)
num_rows <- nrow(df)
num_cols <- ncol(df)

df <- as.data.frame(df)

df$M12_scaled <- (df$M12 - mean(df$M12)) / sd(df$M12)
df$M24_scaled <- (df$M24 - mean(df$M24)) / sd(df$M24)

print(paste("Rows:", num_rows, "Columns:", num_cols))
print(names(df))


print(median_value <- median(data$"NEWASV217", na.rm = TRUE))
print(median_value <- median(data$"NEWASV218", na.rm = TRUE))
```


```{r}
hbp_med_rb <- cmest(data = df, 
                model = "rb", 
                outcome = "HBP", 
                exposure = "M24_scaled",
                mediator = c("NEWASV217", "NEWASV218"), 
                basec = c("age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf",
                          "bmi_missing", "smoking_status_current", "smoking_status_former",
                          "smoking_status_missing", "diabetes2_No", "diabetes2_Yes",
                          "diabetes2_Missing"),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = list("linear", "linear"),  # Mediator regression model
                yreg = "logistic",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"NEWASV217", na.rm = TRUE), median(df$"NEWASV218", na.rm = TRUE))  # Mediator values for computing natural indirect effects
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)

# Print the results
summary(hbp_med_rb)
```


```{r}
df$M12_m <- 0
df[df$M12 > 8.9, ]$M12_m <- 1

table(df$M12_m)

out_glm <- glm(HBP ~ M24_m + age + gender + 
    bmi_18.5_25.0 + bmi_25.0_30.0 + bmi_30.0_inf + bmi_missing + 
    smoking_status_current + smoking_status_former + smoking_status_missing, 
    family = binomial(), data = df)

summary(out_glm)
```

```{r}

str(res_rb)
results <- data.frame(
  Term = names(res_rb$effect.pe),
  Estimate = res_rb$effect.pe,
  Std.error = res_rb$effect.se,
  `95% CIL` = res_rb$effect.ci.low,
  `95% CIU` = res_rb$effect.ci.high,
  P.val = res_rb$effect.pval
)
print(results)

write.csv(results, "/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/result/causal_mediate_PM12_with_BP_EMintFalse.csv", row.names = FALSE)

```

```{r}
### For Cardiometobolics

library(CMAverse)
library(data.table)

# Load data
data <- fread('D:/My postdoc/COMPASS microbiome/causalmediate_Cardiometabolic.csv')
data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

data$NEWASV164[is.na(data$NEWASV164)] <- 0
data$NEWASV048[is.na(data$NEWASV048)] <- 0
data$NEWASV314[is.na(data$NEWASV314)] <- 0
data$NEWASV306[is.na(data$NEWASV306)] <- 0
data$NEWASV069[is.na(data$NEWASV069)] <- 0
data$NEWASV267[is.na(data$NEWASV267)] <- 0
data$NEWASV028[is.na(data$NEWASV028)] <- 0
data$NEWASV147[is.na(data$NEWASV147)] <- 0
data$NEWASV185[is.na(data$NEWASV185)] <- 0
data$NEWASV176[is.na(data$NEWASV176)] <- 0
data$NEWASV313[is.na(data$NEWASV313)] <- 0
data$NEWASV232[is.na(data$NEWASV232)] <- 0
data$NEWASV260[is.na(data$NEWASV260)] <- 0


names(data) <- gsub(pattern = "\\(", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\)", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\[", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\]", replacement = "", x = names(data))
names(data) <- gsub(pattern = "\\,", replacement = "_", x = names(data))
names(data) <- gsub(pattern = " ", replacement = "", x = names(data))

savecols <- c("specimen_id", "age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf", "bmi_missing",'M18','M12','M6','M24', "smoking_status_current", "smoking_status_former",
"diabetes2_No", "diabetes2_Yes",
"Ghrelin","Resistin","Leptin",
"NEWASV164",
"NEWASV048",
"NEWASV314",
"NEWASV306",
"NEWASV069",
"NEWASV267",
"NEWASV028",
"NEWASV147",
"NEWASV185",
"NEWASV176",
"NEWASV313",
"NEWASV232",
"NEWASV260")
#write.csv(data[, ..savecols], #"/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/Datasets/causalmediate_Cardiometabolic_.csv", row.names #= FALSE)



# Define the columns to keep
cols <- c( "age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf", "bmi_missing",'M12',
           "smoking_status_current", "smoking_status_former",  "diabetes2_No", "diabetes2_Yes", 
             "Ghrelin", "Resistin", "Leptin", "M18", "M24",
"NEWASV164",
"NEWASV048",
"NEWASV314",
"NEWASV306",
"NEWASV069",
"NEWASV267",
"NEWASV028",
"NEWASV147",
"NEWASV185",
"NEWASV176",
"NEWASV313",
"NEWASV232",
"NEWASV260"
)
# Subset the data to include only these columns
df <- data[, ..cols]

df$Ghrelin_lg <- log(df$Ghrelin)
df$Leptin_lg <- log(df$Leptin)
df$Resistin_lg <- log(df$Resistin)

df$NEWASV164_reverse <- NA
df$NEWASV164_reverse <-  -df$NEWASV164

data_dimensions <- dim(df)
print(data_dimensions)
num_rows <- nrow(df)
num_cols <- ncol(df)

df <- as.data.frame(df)

print(paste("Rows:", num_rows, "Columns:", num_cols))
print(names(df))

print(median(df$"NEWASV164", na.rm = TRUE))
```


```{r}

ghr_rb <- cmest(data = df, 
                model = "rb", 
                outcome = "Ghrelin_lg", 
                exposure = "M12",
                mediator = c( "NEWASV164",
                              "NEWASV048",
                              "NEWASV314",
                              "NEWASV306",
                              "NEWASV069",
                              "NEWASV267",
                              "NEWASV028",
                              "NEWASV147",
                              "NEWASV185",
                              "NEWASV176",
                              "NEWASV313",
                              "NEWASV232",
                              "NEWASV260"), 
                basec = c("age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf",
                          "bmi_missing", "smoking_status_current", "smoking_status_former",
                          "diabetes2_No", "diabetes2_Yes"),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = rep(list("linear"), 13),   # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"NEWASV164", na.rm = TRUE), 
                            median(df$"NEWASV048", na.rm = TRUE),
                            median(df$"NEWASV314", na.rm = TRUE),
                            median(df$"NEWASV306", na.rm = TRUE),
                            median(df$"NEWASV069", na.rm = TRUE),
                            median(df$"NEWASV267", na.rm = TRUE),
                            median(df$"NEWASV028", na.rm = TRUE),
                            median(df$"NEWASV147", na.rm = TRUE),
                            median(df$"NEWASV185", na.rm = TRUE),
                            median(df$"NEWASV176", na.rm = TRUE),
                            median(df$"NEWASV313", na.rm = TRUE),
                            median(df$"NEWASV232", na.rm = TRUE),
                            median(df$"NEWASV260", na.rm = TRUE))
                            
               # Mediator values for computing natural indirect effects
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)

res_rb <- cmest(data = df, 
                model = "rb", 
                outcome = "Resistin_lg", 
                exposure = "M12",
                mediator = c( "NEWASV164",
                              "NEWASV048",
                              "NEWASV314",
                              "NEWASV306",
                              "NEWASV069",
                              "NEWASV267",
                              "NEWASV028",
                              "NEWASV147",
                              "NEWASV185",
                              "NEWASV176",
                              "NEWASV313",
                              "NEWASV232",
                              "NEWASV260"), 
                basec = c("age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf",
                          "bmi_missing", "smoking_status_current", "smoking_status_former",
                          "diabetes2_No", "diabetes2_Yes"),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = rep(list("linear"), 13),   # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"NEWASV164", na.rm = TRUE), 
                            median(df$"NEWASV048", na.rm = TRUE),
                            median(df$"NEWASV314", na.rm = TRUE),
                            median(df$"NEWASV306", na.rm = TRUE),
                            median(df$"NEWASV069", na.rm = TRUE),
                            median(df$"NEWASV267", na.rm = TRUE),
                            median(df$"NEWASV028", na.rm = TRUE),
                            median(df$"NEWASV147", na.rm = TRUE),
                            median(df$"NEWASV185", na.rm = TRUE),
                            median(df$"NEWASV176", na.rm = TRUE),
                            median(df$"NEWASV313", na.rm = TRUE),
                            median(df$"NEWASV232", na.rm = TRUE),
                            median(df$"NEWASV260", na.rm = TRUE))
                            
               # Mediator values for computing natural indirect effects
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)

lep_rb <- cmest(data = df, 
                model = "rb", 
                outcome = "Leptin_lg", 
                exposure = "M12",
                mediator = c( "NEWASV164",
                              "NEWASV048",
                              "NEWASV314",
                              "NEWASV306",
                              "NEWASV069",
                              "NEWASV267",
                              "NEWASV028",
                              "NEWASV147",
                              "NEWASV185",
                              "NEWASV176",
                              "NEWASV313",
                              "NEWASV232",
                              "NEWASV260"), 
                basec = c("age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf",
                          "bmi_missing", "smoking_status_current", "smoking_status_former",
                          "diabetes2_No", "diabetes2_Yes"),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = rep(list("linear"), 13),   # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"NEWASV164", na.rm = TRUE), 
                            median(df$"NEWASV048", na.rm = TRUE),
                            median(df$"NEWASV314", na.rm = TRUE),
                            median(df$"NEWASV306", na.rm = TRUE),
                            median(df$"NEWASV069", na.rm = TRUE),
                            median(df$"NEWASV267", na.rm = TRUE),
                            median(df$"NEWASV028", na.rm = TRUE),
                            median(df$"NEWASV147", na.rm = TRUE),
                            median(df$"NEWASV185", na.rm = TRUE),
                            median(df$"NEWASV176", na.rm = TRUE),
                            median(df$"NEWASV313", na.rm = TRUE),
                            median(df$"NEWASV232", na.rm = TRUE),
                            median(df$"NEWASV260", na.rm = TRUE))
                            
               # Mediator values for computing natural indirect effects
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)

# Print the results
summary(res_rb)
```


```{r}
#UMAP analysis

library(umap)
library(ggplot2)

#Read data
compass_dia <- read.csv("D:/My postdoc/COMPASS microbiome/compass_diabetes.csv")
micro_original <- read.csv("D:/My postdoc/COMPASS microbiome/microbiome_combine_790row_480col.csv")

#sort by ID
compass_dia <- compass_dia[order(compass_dia$sampleID),]
micro_original <- micro_original[order(micro_original$sampleID),]

#Merge for diabetes
micro_merge <- merge(micro_original, compass_dia, by = "sampleID", all.y = FALSE)
micro_merge[micro_merge$diabetes2 == "", ]$diabetes2 <- "Missing"
micro_merge[micro_merge$diabetes2 == "I don't know", ]$diabetes2 <- "Missing"
micro_merge[micro_merge$diabetes2 == "I prefer not to answer", ]$diabetes2 <- "Missing"

#Create dataset for UMAP
micro_umap <- subset(micro_merge, select = -c(sampleID, diabetes2))

#UMAP analysis using original microbiome data
umap_results <- umap(micro_umap, n_components = 2, n_neighbors = 15, min_dist = 0.1)

umap_df <- as.data.frame(umap_results$layout)
colnames(umap_df) <- c("UMAP1", "UMAP2")

#Merge UMAP results with diabetes
umap_df$Group <- as.factor(micro_merge$diabetes2)
umap_df[umap_df$Group == "", ]$Group <- "Missing"

#Create the UMAP plot
ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = Group)) +
  geom_point(alpha = 0.8) +
  theme_minimal() +
  labs(title = "UMAP Projection of Microbiome Data",
       x = "UMAP 1",
       y = "UMAP 2",
       color = "Sample Group")
```


```{r}
# PCoA (or NMDS) analysis

library(tidyverse)
library(vegan)

#Read data, beta diversity
microBeta <- read.csv("D:/My postdoc/COMPASS microbiome/microbiome_combine_790row_480col_bray_curtis.csv")

#Select rows and columns from the beta diversity matrix
colsel <- paste("X", micro_merge$sampleID, sep="")
rowsel <- micro_merge$sampleID

coloverlap <- intersect(colsel, colnames(microBeta))
rowoverlap <- intersect(rowsel, microBeta$sampleID)

microBeta_sel <- microBeta[microBeta$sampleID %in% rowoverlap , c(coloverlap)]

#Find the row number where value = 0 for each column
zero_rows <- numeric(746)

for(i in 1:746){
  zero_rows[i] <- which(microBeta_sel[, i] == 0)
}


# Create dataset for NMDS
dist_str <- vegdist(microBeta_sel, method="bray")

###NMDS analysis
set.seed(1993)
#nmds <- metaMDS(dist_str, autotransform = FALSE)
nmds_w <- metaMDS(dist_str)

###Create new dataset after NMDS plot
nmds_points <- scores(nmds_w) %>% as_tibble(rownames = "sampleID")
nmds_points[zero_rows, ]$sampleID <-  as.numeric(substring(colnames(microBeta_sel), 2))


nmds_df <- nmds_points %>% 
  inner_join(., micro_merge, by="sampleID") 


#Plots
nmds_df[nmds_df$diabetes2 == "", ]$diabetes2 <- "Missing"

nmdsplot <- 
  ggplot(nmds_df, aes(x=NMDS1, y=NMDS2, color = as.factor(diabetes2))) +
  geom_point() + 
  stat_ellipse(type = "t", level = 0.95, geom = "polygon", aes(fill = NA, color=as.factor(diabetes2)), alpha = 0) +
  scale_fill_manual(values = NA)

nmdsplot

```


```{r}
library(HIMA)

hima_fit <- qHIMA(X = df$M12, Y = df$Ghrelin_lg, 
                      OTU = df[c("NEWASV164",
                              "NEWASV048",
                              "NEWASV314",
                              "NEWASV306",
                              "NEWASV069",
                              "NEWASV267",
                              "NEWASV028",
                              "NEWASV147",
                              "NEWASV185",
                              "NEWASV176",
                              "NEWASV313",
                              "NEWASV232",
                              "NEWASV260")],
                      COV = df[c("age", "gender", "bmi_18.5_25.0", "bmi_25.0_30.0", "bmi_30.0_inf",
                          "bmi_missing", "smoking_status_current", "smoking_status_former",
                          "diabetes2_No", "diabetes2_Yes")])

summary(df$bmi_18.5_25.0)
```

```{r}

str(res_rb)
results <- data.frame(
  Term = names(res_rb$effect.pe),
  Estimate = res_rb$effect.pe,
  Std.error = res_rb$effect.se,
  `95% CIL` = res_rb$effect.ci.low,
  `95% CIU` = res_rb$effect.ci.high,
  P.val = res_rb$effect.pval
)
print(results)

write.csv(results, "/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/result/causal_mediate_PM12_with_Cardiometobolic_EMintTrue.csv", row.names = FALSE)





```