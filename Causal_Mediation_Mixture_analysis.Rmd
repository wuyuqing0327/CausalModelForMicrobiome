---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
```{r} 
##### Mediation Analysis
### Resistin & M12

library(CMAverse)
library(data.table)
library(fastDummies)
library(dplyr)
library(psych)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)

# Convert df to a data frame if it's a data table
if ("data.table" %in% class(df)) {
  df <- as.data.frame(df)
}

### drop nan value of biomarker and air pollution
na_in_M12 <- sum(is.na(df$M12))
print(paste("NA in M12:", na_in_M12))
na_in_Resistin <- sum(is.na(df$Resistin))
print(paste("NA in Resistin:", na_in_Resistin))

df <- df[!is.na(df$M12), ]
df <- df[!is.na(df$Resistin), ]

df$Resistin_v2 <- log(df$Resistin)
df$Resistin_v3 <- (df$Resistin_v2 - mean(df$Resistin_v2)) / sd(df$Resistin_v2)



#Latent variable
res_micro <- c('UPDASV260', 'UPDASV105', 'UPDASV468', 'UPDASV339', 'UPDASV375', 'UPDASV311')


df$res_lv <- as.numeric(fa(df[res_micro], rotate = "none")$scores)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))



Resistin_med_rb <- cmest( data = df, 
                model = "rb", 
                outcome = "Resistin_v3", 
                exposure = "M12",
                mediator = c("res_lv"), 
                basec = c('age', 'gender_Male',
                          'bmi_binned2_30.0_inf','bmi_binned2_25.0_30.0','bmi_binned2_inf_18.5',
                          'smoking_status_Current','smoking_status_Former',
                          'diabetes2_Yes'),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = list("linear"),  # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$res_lv, na.rm = TRUE))
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)


summary(Resistin_med_rb)

str(Resistin_med_rb)
Resistin_results <- data.frame(
  Term = names(Resistin_med_rb$effect.pe),
  Estimate = Resistin_med_rb$effect.pe,
  Std.error = Resistin_med_rb$effect.se,
  `95% CIL` = Resistin_med_rb$effect.ci.low,
  `95% CIU` = Resistin_med_rb$effect.ci.high,
  P.val = Resistin_med_rb$effect.pval
)
print(Resistin_results)


```




```{r}
##### Mediation Analysis
### Ghrelin & M12
library(CMAverse)
library(data.table)
library(fastDummies)
library(dplyr)
library(psych)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)

# Convert df to a data frame if it's a data table
if ("data.table" %in% class(df)) {
  df <- as.data.frame(df)
}

### drop nan value of biomarker and air pollution
na_in_M12 <- sum(is.na(df$M12))
print(paste("NA in M12:", na_in_M12))
na_in_Ghrelin <- sum(is.na(df$Ghrelin))
print(paste("NA in Ghrelin:", na_in_Ghrelin))

df <- df[!is.na(df$M12), ]
df <- df[!is.na(df$Ghrelin), ]

df$Ghrelin_v2 <- log(df$Ghrelin)
df$Ghrelin_v3 <- (df$Ghrelin_v2 - mean(df$Ghrelin_v2)) / sd(df$Ghrelin_v2)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))

#Latent variable
gr_micro <- c('UPDASV260',
               'UPDASV105',
               'UPDASV468',
               'UPDASV339',
               'UPDASV375',
               'UPDASV397',
               'UPDASV190')

df$gr_lv <- as.numeric(fa(df[gr_micro], rotate = "none")$scores)


Ghrelin_med_rb <- cmest( data = df, 
                model = "rb", 
                outcome = "Ghrelin_v3", 
                exposure = "M12",
                mediator = c("gr_lv"), 
                basec = c('age', 'gender_Male',
                          'bmi_binned2_30.0_inf','bmi_binned2_25.0_30.0','bmi_binned2_inf_18.5',
                          'smoking_status_Current','smoking_status_Former',
                          'diabetes2_Yes'),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = list('linear'),  # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"gr_lv", na.rm = TRUE))
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)


summary(Ghrelin_med_rb)

str(Ghrelin_med_rb)
Ghrelin_results <- data.frame(
  Term = names(Ghrelin_med_rb$effect.pe),
  Estimate = Ghrelin_med_rb$effect.pe,
  Std.error = Ghrelin_med_rb$effect.se,
  `95% CIL` = Ghrelin_med_rb$effect.ci.low,
  `95% CIU` = Ghrelin_med_rb$effect.ci.high,
  P.val = Ghrelin_med_rb$effect.pval
)
print(Ghrelin_results)

```




```{r}
##### Mediation Analysis
### Insulin & M12
library(CMAverse)
library(data.table)
library(fastDummies)
library(dplyr)
library(psych)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)

# Convert df to a data frame if it's a data table
if ("data.table" %in% class(df)) {
  df <- as.data.frame(df)
}

### drop nan value of biomarker and air pollution
na_in_M12 <- sum(is.na(df$M12))
print(paste("NA in M12:", na_in_M12))
na_in_Insulin <- sum(is.na(df$Insulin))
print(paste("NA in Insulin:", na_in_Insulin))

df <- df[!is.na(df$M12), ]
df <- df[!is.na(df$Insulin), ]

df$Insulin_v2 <- log(df$Insulin)
df$Insulin_v3 <- (df$Insulin_v2 - mean(df$Insulin_v2)) / sd(df$Insulin_v2)


#Insulin significant microbiome done by 2024
#ins_micro <- c('UPDASV260','UPDASV105','UPDASV468','UPDASV339','UPDASV375','UPDASV311','UPDASV270')

### Insulin significant microbiome done by 2025 (filter microbiome which missing over 50%)
ins_micro <- c('UPDASV073', 'UPDASV270', 'UPDASV224')

df$ins_lv <- as.numeric(fa(df[ins_micro], rotate = "none")$scores)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))



vars_in_model <- c(
  "Insulin_v3",    # outcome  (Y)
  "M12",           # exposure (A)
  "ins_lv",        # mediator (M)
'age', 'gender_Male',
'bmi_binned2_30.0_inf','bmi_binned2_25.0_30.0','bmi_binned2_inf_18.5',
'smoking_status_Current','smoking_status_Former',
'diabetes2_Yes'
)

Insulin_med_rb <- cmest( data = df[ , vars_in_model ], 
                model = "rb", 
                outcome = "Insulin_v3", 
                exposure = "M12",
                mediator = c("ins_lv"), 
                basec = c('age', 'gender_Male',
                          'bmi_binned2_30.0_inf','bmi_binned2_25.0_30.0','bmi_binned2_inf_18.5',
                          'smoking_status_Current','smoking_status_Former',
                          'diabetes2_Yes'),
                EMint = FALSE,  # Set TRUE if expecting interaction effects
                mreg = list("linear"),
                #mreg = as.list(rep("linear",7)),  # Mediator regression model
                yreg = "linear",  # Outcome regression model
                astar = 0, 
                a = 1, 
                mval = list(median(df$"ins_lv", na.rm = TRUE))
                #estimation = "imputation", 
                #inference = "bootstrap", 
                #nboot = 500  # Number of bootstrap samples for inference
)


summary(Insulin_med_rb)

str(Insulin_med_rb)
Insulin_results <- data.frame(
  Term = names(Insulin_med_rb$effect.pe),
  Estimate = Insulin_med_rb$effect.pe,
  Std.error = Insulin_med_rb$effect.se,
  `95% CIL` = Insulin_med_rb$effect.ci.low,
  `95% CIU` = Insulin_med_rb$effect.ci.high,
  P.val = Insulin_med_rb$effect.pval
)
print(Insulin_results)


```




```{r}
### Mediation Analysis summary

# Extracting 'te' and 'cde' rows from each results dataframe
te_cde_ghrelin <- Ghrelin_results[Ghrelin_results$Term %in% c("te", "cde"),]
#te_cde_leptin <- Leptin_results[Leptin_results$Term %in% c("te", "cde"),]
te_cde_insulin <- Insulin_results[Insulin_results$Term %in% c("te", "cde"),]
te_cde_resistin <- Resistin_results[Resistin_results$Term %in% c("te", "cde"),]

# Renaming 'Estimate' column for clarity
te_cde_ghrelin$Estimate <- paste0(round(te_cde_ghrelin$Estimate, 2), " (", round(te_cde_ghrelin$X95..CIL, 2), ", ", round(te_cde_ghrelin$X95..CIU, 2), ")")
te_cde_leptin$Estimate <- paste0(round(te_cde_leptin$Estimate, 2), " (", round(te_cde_leptin$X95..CIL, 2), ", ", round(te_cde_leptin$X95..CIU, 2), ")")
te_cde_insulin$Estimate <- paste0(round(te_cde_insulin$Estimate, 2), " (", round(te_cde_insulin$X95..CIL, 2), ", ", round(te_cde_insulin$X95..CIU, 2), ")")
te_cde_resistin$Estimate <- paste0(round(te_cde_resistin$Estimate, 2), " (", round(te_cde_resistin$X95..CIL, 2), ", ", round(te_cde_resistin$X95..CIU, 2), ")")

# Selecting only the Term and Estimate columns
te_cde_ghrelin <- te_cde_ghrelin[, c("Term", "Estimate")]
te_cde_leptin <- te_cde_leptin[, c("Term", "Estimate")]
te_cde_insulin <- te_cde_insulin[, c("Term", "Estimate")]
te_cde_resistin <- te_cde_resistin[, c("Term", "Estimate")]


print(te_cde_ghrelin)
print(te_cde_leptin)
print(te_cde_insulin)
print(te_cde_resistin)
library(openxlsx)
write.xlsx(combined_results, "C:/Users/yuqingw1/Workfolder/result/biomarkers_meidate_results.xlsx")

```







```{r}


```



```{r}
##### Mixture Analysis, calculate the conjunct influence

### For Ghrelin 
library(gWQS)
library(ggplot2)
library(knitr)
library(kableExtra)
library(reshape2)
library(data.table)
library(fastDummies)
library(dplyr)
library(readxl)
library(stringr)
library(CMAverse)
library(psych)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)



### drop nan value of biomarker and air pollution
na_in_Ghrelin <- sum(is.na(df$Ghrelin))
print(paste("NA in Ghrelin:", na_in_Ghrelin))

df <- df[!is.na(df$Ghrelin), ]

df$Ghrelin_v2 <- log(df$Ghrelin)
df$Ghrelin_v3 <- (df$Ghrelin_v2 - mean(df$Ghrelin_v2)) / sd(df$Ghrelin_v2)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))


pwqs <- c('UPDASV219', 'UPDASV290', 'UPDASV388', 'UPDASV451', 'UPDASV412', 'UPDASV161', 'UPDASV111', 'UPDASV125', 'UPDASV199', 'UPDASV213', 'UPDASV397', 'UPDASV355', 'UPDASV036', 'UPDASV100', 'UPDASV431', 'UPDASV040', 'UPDASV315', 'UPDASV403', 'UPDASV423', 'UPDASV324', 'UPDASV119', 'UPDASV365', 'UPDASV283', 'UPDASV023', 'UPDASV381', 'UPDASV109', 'UPDASV332', 'UPDASV015', 'UPDASV275', 'UPDASV300', 'UPDASV241', 'UPDASV003', 'UPDASV009', 'UPDASV027', 'UPDASV034', 'UPDASV047', 'UPDASV048', 'UPDASV050', 'UPDASV056', 'UPDASV067', 'UPDASV068', 'UPDASV071', 'UPDASV074', 'UPDASV080', 'UPDASV091', 'UPDASV095', 'UPDASV102', 'UPDASV106', 'UPDASV107', 'UPDASV114', 'UPDASV123', 'UPDASV143', 'UPDASV148', 'UPDASV171', 'UPDASV189', 'UPDASV193', 'UPDASV194', 'UPDASV196', 'UPDASV201', 'UPDASV208', 'UPDASV214', 'UPDASV221', 'UPDASV235', 'UPDASV237', 'UPDASV244', 'UPDASV247', 'UPDASV248', 'UPDASV249', 'UPDASV257', 'UPDASV267', 'UPDASV274', 'UPDASV295', 'UPDASV297', 'UPDASV312', 'UPDASV323', 'UPDASV334', 'UPDASV335', 'UPDASV347', 'UPDASV351', 'UPDASV357', 'UPDASV363', 'UPDASV364', 'UPDASV373', 'UPDASV379', 'UPDASV383', 'UPDASV395', 'UPDASV400', 'UPDASV407', 'UPDASV408', 'UPDASV411', 'UPDASV414', 'UPDASV418', 'UPDASV437', 'UPDASV443', 'UPDASV453', 'UPDASV454', 'UPDASV455', 'UPDASV469', 'UPDASV477', 'UPDASV478', 'UPDASV245', 'UPDASV284', 'UPDASV005', 'UPDASV070', 'UPDASV044', 'UPDASV170', 'UPDASV210', 'UPDASV378', 'UPDASV419', 'UPDASV033', 'UPDASV466', 'UPDASV232', 'UPDASV352', 'UPDASV133', 'UPDASV427', 'UPDASV259', 'UPDASV156', 'UPDASV320', 'UPDASV177', 'UPDASV271', 'UPDASV110', 'UPDASV020', 'UPDASV449', 'UPDASV269', 'UPDASV002', 'UPDASV227', 'UPDASV182', 'UPDASV462', 'UPDASV117', 'UPDASV179', 'UPDASV353', 'UPDASV426', 'UPDASV007', 'UPDASV279', 'UPDASV242', 'UPDASV448', 'UPDASV317', 'UPDASV132', 'UPDASV138', 'UPDASV021', 'UPDASV416', 'UPDASV479', 'UPDASV112', 'UPDASV301', 'UPDASV206', 'UPDASV330', 'UPDASV344', 'UPDASV041', 'UPDASV425', 'UPDASV246', 'UPDASV231', 'UPDASV328', 'UPDASV277', 'UPDASV135', 'UPDASV069', 'UPDASV031', 'UPDASV288', 'UPDASV205', 'UPDASV226', 'UPDASV441', 'UPDASV093', 'UPDASV098', 'UPDASV078', 'UPDASV159', 'UPDASV172', 'UPDASV121', 'UPDASV433', 'UPDASV167', 'UPDASV099', 'UPDASV263', 'UPDASV038', 'UPDASV230', 'UPDASV305', 'UPDASV141', 'UPDASV457', 'UPDASV229', 'UPDASV272', 'UPDASV458', 'UPDASV484', 'UPDASV343', 'UPDASV255', 'UPDASV140', 'UPDASV183', 'UPDASV405', 'UPDASV190', 'UPDASV042', 'UPDASV464', 'UPDASV471', 'UPDASV396', 'UPDASV325', 'UPDASV452', 'UPDASV354', 'UPDASV160', 'UPDASV145', 'UPDASV052')

nwqs <- c('UPDASV260', 'UPDASV092', 'UPDASV087', 'UPDASV105', 'UPDASV346', 'UPDASV468', 'UPDASV337', 'UPDASV281', 'UPDASV339', 'UPDASV389', 'UPDASV001', 'UPDASV375', 'UPDASV384', 'UPDASV154', 'UPDASV037', 'UPDASV265', 'UPDASV222', 'UPDASV225', 'UPDASV218', 'UPDASV073')

mixedcor <- c(pwqs, nwqs)


###### based on Insulin
pwqs <- c('UPDASV260',
         'UPDASV092',
         'UPDASV087',
         'UPDASV105',
         'UPDASV346',
         'UPDASV468',
         'UPDASV337',
         'UPDASV281',
         'UPDASV339',
         'UPDASV389',
         #'UPDASV001',
         'UPDASV375',
         'UPDASV384',
         'UPDASV037',
         'UPDASV218',
         'UPDASV073',
         'UPDASV286',
         'UPDASV278',
         'UPDASV311',
         'UPDASV212',
         'UPDASV134',
         'UPDASV256',
         'UPDASV089',
         'UPDASV064',
         'UPDASV173',
         'UPDASV224',
         'UPDASV435')

nwqs <- c('UPDASV195', 'UPDASV270', 'UPDASV153', 'UPDASV422')
mixedcor <- c(pwqs, nwqs)


mixedcor_df <- data.frame(Index = mixedcor)

# Read taxonIDname dataframe
taxonIDname <- read_excel("C:\\Users\\yuqingw1\\Workfolder\\ProcessingData\\processing_4_microbiome_new\\taxonIDmappingdict.xlsx")

# Merge mixedcor_df with taxonIDname
merged_df <- mixedcor_df %>%
  inner_join(taxonIDname, by = c("Index" = "newtaxonID"))


# Define the custom function
extract_name <- function(row) {
  attlist <- str_split(row, ",")[[1]]

  if (attlist[length(attlist)] == 'nan') {
    if (attlist[length(attlist) - 1] != 'nan') {
      name <- paste(attlist[length(attlist) - 1], '(unknown genus)' )
    } else if (attlist[length(attlist) - 2] != 'nan') {
      name <- paste(attlist[length(attlist) - 2], '(unknown genus)' )
    } else if (attlist[length(attlist) - 3] != 'nan') {
      name <- paste(attlist[length(attlist) - 3], '(unknown genus)' )
    } else if (attlist[length(attlist) - 4] != 'nan') {
      name <- paste(attlist[length(attlist) - 4], '(unknown genus)' )
    } else {
      name <- paste(attlist[length(attlist) - 5], '(unknown genus)' )
    }
  } else {
    name <- attlist[length(attlist)]
  }

  return(name)
}

# Assuming 'name' is the data frame and 'attribute' is the column
merged_df <- merged_df %>%
  mutate(newname = sapply(attribute, extract_name))
merged_df$newname <- gsub("_", " ", merged_df$newname)

#merged_df$newname[merged_df$Index == "UPDASV290"] <- "Lactobacillaceae Gene:Weissella (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV471"] <- "Leuconostocaceae Gene:Weissella (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV048"] <- "Akkermansiaceae Gene:Akkermansia (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV095"] <- "Verrucomicrobiaceae Gene:Akkermansia (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV068"] <- "Enterobacteriaceae Gene:Pantoea (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV323"] <- "Erwiniaceae Gene:Pantoea (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV074"] <- "Flavobacteriaceae Gene:Empedobacter (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV227"] <- "Weeksellaceae Gene:Empedobacter (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV042"] <- "Propionibacteriales Gene:Tessaracoccus (unknown genus)"
#merged_df$newname[merged_df$Index == "UPDASV325"] <- "Actinomycetales Gene:Tessaracoccus (unknown genus)"


# Convert mixedcor values to new names
mixedcor_with_newnames <- merged_df$newname


name_mapping <- merged_df %>%
  filter(Index %in% colnames(df)) %>%
  select(Index, newname)

# Create a named vector for renaming
rename_vector <- setNames(name_mapping$Index, name_mapping$newname)

# Rename the columns in df
df <- df %>%
  rename(!!!rename_vector)

pwqs_newnames <- name_mapping$newname[name_mapping$Index %in% pwqs]
nwqs_newnames <- name_mapping$newname[name_mapping$Index %in% nwqs]
pwqs <- as.character(pwqs_newnames)
nwqs <- as.character(nwqs_newnames)


#### mixture model
formula_str <- "Ghrelin_v3 ~ pwqs + nwqs + age + gender_Male + bmi_binned2_30.0_inf + bmi_binned2_inf_18.5 + smoking_status_Current + diabetes2_Yes"


Ghrelin_results2i <- gwqs(formula = as.formula(formula_str),
                          mix_name = mixedcor_with_newnames, 
                          data = df, 
                          q = 10, validation = 0, b = 100, b1_pos = FALSE, rh=2, family = "gaussian", seed = 2024)

summary(Ghrelin_results2i)



Ghrelin_summary_model <- summary(Ghrelin_results2i)
# Extract coefficients
Ghrelin_coefficients_info <- Ghrelin_summary_model$coefficients  # This usually contains estimates, std. error, t-value, and p-value
# Get confidence intervals
Ghrelin_conf_intervals <- confint(Ghrelin_results2i, level = 0.95)  # Adjust the level if needed
# Base R approach
Ghrelin_coefficients_df <- data.frame(Ghrelin_coefficients_info)
Ghrelin_conf_intervals_df <- data.frame(Ghrelin_conf_intervals)
# Naming the columns correctly
names(Ghrelin_conf_intervals_df) <- c("2.5 %", "97.5 %")
# Combining the estimates and confidence intervals
Ghrelin_final_df <- cbind(Ghrelin_coefficients_df, Ghrelin_conf_intervals_df)
# If you only want certain columns (Estimate, Std. Error, 2.5 %, 97.5 %)
Ghrelin_final_df <- Ghrelin_final_df[, c("Estimate", "Std..Error", "2.5 %", "97.5 %")]
print(Ghrelin_final_df)



print(gwqs_summary_tab(Ghrelin_results2i))
Ghrelin_mf_df <- as.data.frame(signif(coef(summary(Ghrelin_results2i)), 3))
print(kable_styling(kable(Ghrelin_mf_df, row.names = TRUE)))

print(gwqs_weights_tab(Ghrelin_results2i))
Ghrelin_final_weight <- Ghrelin_results2i$final_weights
Ghrelin_final_weight[, -1] <- signif(Ghrelin_final_weight[, -1], 3)
print(kable_styling(kable(Ghrelin_final_weight, row.names = FALSE)))





###### Ghrelin Step 2
# we run the model setting the penalization term equal to 90
Ghrelin_results2i_l90 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = FALSE,rh=2,
                               family = "gaussian", seed = 2024, lambda = 90)

# we run the model setting the penalization term equal to 900
Ghrelin_results2i_l900 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 199, b1_pos = FALSE,rh=2,
                               family = "gaussian", seed = 2024, lambda = 900)

# we run the model setting the penalization term equal to 900
Ghrelin_results2i_l9000 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = FALSE,rh=2,
                               family = "gaussian", seed = 2024, lambda = 9000)

Ghrelin_lambda_AIC_2i <- data.frame(lambda = c(0, 90, 900, 9000),
                            AIC = c(Ghrelin_results2i$fit$aic, Ghrelin_results2i_l90$fit$aic, 
                                    Ghrelin_results2i_l900$fit$aic, Ghrelin_results2i_l9000$fit$aic))

print(kable(Ghrelin_lambda_AIC_2i) %>% kable_styling())



### PLOT 
gwqs_boxplot(Ghrelin_results2i)


# Save the model
save(Ghrelin_results2i, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Ghrelin_results2i.RData")
save(Ghrelin_results2i_l90, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Ghrelin_results2i_l90.RData")
save(Ghrelin_results2i_l900, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Ghrelin_results2i_l900.RData")
save(Ghrelin_results2i_l9000, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Ghrelin_results2i_l9000.RData")
# Later, you can load the model
#load("Ghrelin_results2i.RData")
# Check the loaded model
#print(Ghrelin_results2i)


```

```{r}
library(ggplot2)

ghrelin_boxplot <- gwqs_boxplot(Ghrelin_results2i) +
  labs(x = NULL, y=NULL, title = "Ghrelin conjunct influence") +
  theme(plot.title = element_text(hjust = 0.5))
        #axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 
# Print the plot to display it
print(ghrelin_boxplot)

```



```{r}
##### Mixture Analysis, calculate the conjunct influence

### For Resistin 
library(gWQS)
library(ggplot2)
library(knitr)
library(kableExtra)
library(reshape2)
library(data.table)
library(fastDummies)
library(dplyr)
library(readxl)
library(stringr)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)



### drop nan value of biomarker and air pollution
na_in_Resistin <- sum(is.na(df$Resistin))
print(paste("NA in Resistin:", na_in_Resistin))

df <- df[!is.na(df$Resistin), ]

df$Resistin_v2 <- log(df$Resistin)
df$Resistin_v3 <- (df$Resistin_v2 - mean(df$Resistin_v2)) / sd(df$Resistin_v2)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))


pwqs <- c('UPDASV260',
         'UPDASV092',
         'UPDASV087',
         'UPDASV105',
         'UPDASV346',
         'UPDASV468',
         'UPDASV337',
         'UPDASV281',
         'UPDASV339',
         'UPDASV389',
         'UPDASV001',
         'UPDASV375',
         'UPDASV384',
         'UPDASV037',
         'UPDASV218',
         'UPDASV286',
         'UPDASV278',
         'UPDASV311',
         'UPDASV212',
         'UPDASV256',
         'UPDASV126')

nwqs <- c('UPDASV444')
mixedcor <- c(pwqs, nwqs)

###### based on Insulin
pwqs <- c('UPDASV260',
         'UPDASV092',
         'UPDASV087',
         'UPDASV105',
         'UPDASV346',
         'UPDASV468',
         'UPDASV337',
         'UPDASV281',
         'UPDASV339',
         'UPDASV389',
         #'UPDASV001',
         'UPDASV375',
         'UPDASV384',
         'UPDASV037',
         'UPDASV218',
         'UPDASV073',
         'UPDASV286',
         'UPDASV278',
         'UPDASV311',
         'UPDASV212',
         'UPDASV134',
         'UPDASV256',
         'UPDASV089',
         'UPDASV064',
         'UPDASV173',
         'UPDASV224',
         'UPDASV435')

nwqs <- c('UPDASV195', 'UPDASV270', 'UPDASV153', 'UPDASV422')
mixedcor <- c(pwqs, nwqs)



mixedcor_df <- data.frame(Index = mixedcor)

# Read taxonIDname dataframe
taxonIDname <- read_excel("C:\\Users\\yuqingw1\\Workfolder\\ProcessingData\\processing_4_microbiome_new\\taxonIDmappingdict.xlsx")

# Merge mixedcor_df with taxonIDname
merged_df <- mixedcor_df %>%
  inner_join(taxonIDname, by = c("Index" = "newtaxonID"))

# Define the custom function
extract_name <- function(row) {
  attlist <- str_split(row, ",")[[1]]

  if (attlist[length(attlist)] == 'nan') {
    if (attlist[length(attlist) - 1] != 'nan') {
      name <- paste(attlist[length(attlist) - 1], '(unknown genus)' )
    } else if (attlist[length(attlist) - 2] != 'nan') {
      name <- paste(attlist[length(attlist) - 2], '(unknown genus)' )
    } else if (attlist[length(attlist) - 3] != 'nan') {
      name <- paste(attlist[length(attlist) - 3], '(unknown genus)' )
    } else if (attlist[length(attlist) - 4] != 'nan') {
      name <- paste(attlist[length(attlist) - 4], '(unknown genus)' )
    } else {
      name <- paste(attlist[length(attlist) - 5], '(unknown genus)' )
    }
  } else {
    name <- attlist[length(attlist)]
  }

  return(name)
}

# Assuming 'name' is the data frame and 'attribute' is the column
merged_df <- merged_df %>%
  mutate(newname = sapply(attribute, extract_name))
merged_df$newname <- gsub("_", " ", merged_df$newname)

# Convert mixedcor values to new names
mixedcor_with_newnames <- merged_df$newname


name_mapping <- merged_df %>%
  filter(Index %in% colnames(df)) %>%
  select(Index, newname)

# Create a named vector for renaming
rename_vector <- setNames(name_mapping$Index, name_mapping$newname)

# Rename the columns in df
df <- df %>%
  rename(!!!rename_vector)

pwqs_newnames <- name_mapping$newname[name_mapping$Index %in% pwqs]
nwqs_newnames <- name_mapping$newname[name_mapping$Index %in% nwqs]
pwqs <- as.character(pwqs_newnames)
nwqs <- as.character(nwqs_newnames)


#### mixture model
formula_str <- "Resistin_v3 ~ pwqs + nwqs + age + gender_Male + bmi_binned2_30.0_inf + bmi_binned2_inf_18.5 + smoking_status_Current + diabetes2_Yes"



Resistin_results2i <- gwqs(formula = as.formula(formula_str),
                          mix_name = mixedcor_with_newnames, 
                          data = df, 
                          q = 10, validation = 0, b = 100, b1_pos = TRUE,rh=2,
                          family = "gaussian", seed = 2024)

summary(Resistin_results2i)



Resistin_summary_model <- summary(Resistin_results2i)
# Extract coefficients
Resistin_coefficients_info <- Resistin_summary_model$coefficients  # This usually contains estimates, std. error, t-value, and p-value
# Get confidence intervals
Resistin_conf_intervals <- confint(Resistin_results2i, level = 0.95)  # Adjust the level if needed
# Base R approach
Resistin_coefficients_df <- data.frame(Resistin_coefficients_info)
Resistin_conf_intervals_df <- data.frame(Resistin_conf_intervals)
# Naming the columns correctly
names(Resistin_conf_intervals_df) <- c("2.5 %", "97.5 %")
# Combining the estimates and confidence intervals
Resistin_final_df <- cbind(Resistin_coefficients_df, Resistin_conf_intervals_df)
# If you only want certain columns (Estimate, Std. Error, 2.5 %, 97.5 %)
Resistin_final_df <- Resistin_final_df[, c("Estimate", "Std..Error", "2.5 %", "97.5 %")]
print(Resistin_final_df)


print(gwqs_summary_tab(Resistin_results2i))
Resistin_mf_df <- as.data.frame(signif(coef(summary(Resistin_results2i)), 3))
print(kable_styling(kable(Resistin_mf_df, row.names = TRUE)))

print(gwqs_weights_tab(Resistin_results2i))
Resistin_final_weight <- Resistin_results2i$final_weights
Resistin_final_weight[, -1] <- signif(Resistin_final_weight[, -1], 3)
print(kable_styling(kable(Resistin_final_weight, row.names = FALSE)))





###### Resistin Step 2
# we run the model setting the penalization term equal to 90
Resistin_results2i_l90 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2, 
                               family = "gaussian", seed = 2024, lambda = 90)

# we run the model setting the penalization term equal to 900
Resistin_results2i_l900 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                               family = "gaussian", seed = 2024, lambda = 900)

# we run the model setting the penalization term equal to 900
Resistin_results2i_l9000 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                               family = "gaussian", seed = 2024, lambda = 9000)

Resistin_lambda_AIC_2i <- data.frame(lambda = c(0, 90, 900, 9000),
                            AIC = c(Resistin_results2i$fit$aic, Resistin_results2i_l90$fit$aic, 
                                    Resistin_results2i_l900$fit$aic, Resistin_results2i_l9000$fit$aic))

print(kable(Resistin_lambda_AIC_2i) %>% kable_styling())


# Save the model
save(Resistin_results2i, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Resistin_results2i.RData")
save(Resistin_results2i_l90, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Resistin_results2i_l90.RData")
save(Resistin_results2i_l900, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Resistin_results2i_l900.RData")
save(Resistin_results2i_l9000, file = "C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Resistin_results2i_l9000.RData")
# Later, you can load the model
#load("Resistin_results2i.RData")
# Check the loaded model
#print(Resistin_results2i)


```

```{r}
### Resistin plot
library(ggplot2)

Resistin_box <- gwqs_boxplot(Resistin_results2i) +
  labs(x = NULL, y=NULL, title = "Resistin conjunct infulence") +
  theme(plot.title = element_text(hjust = 0.5))
 # (axis.text.x = element_text(size = 4, angle = 45, hjust = 1)))

print(Resistin_box)


```









```{r}
##### Mixture Analysis, calculate the conjunct influence

### For Insulin 
library(gWQS)
library(ggplot2)
library(knitr)
library(kableExtra)
library(reshape2)
library(data.table)
library(fastDummies)
library(dplyr)
library(readxl)
library(stringr)

# Load data
data <- fread("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/microbiome_allvariable_806_transformation.csv")

data_dimensions <- dim(data)
print(data_dimensions)
num_rows <- nrow(data)
num_cols <- ncol(data)
print(paste("Rows:", num_rows, "Columns:", num_cols))

# Define cut points
cutPoints <- c(18.5, 25, 30)
subset_data <- data[!is.na(data$bmi),]
subset_data$bmi_binned2 <- cut(subset_data$bmi, breaks = c(-Inf, cutPoints, Inf), labels = FALSE)
subset_data$bmi_binned2 <- as.character(subset_data$bmi_binned2)
missing_data <- data[is.na(data$bmi),]
missing_data$bmi_binned2 <- "missing"
data <- rbind(subset_data, missing_data)
new_labels <- c(
  "inf_18.5",
  "18.5_25.0",
  "25.0_30.0",
  "30.0_inf",
  "missing"
)
data$bmi_binned2 <- factor(data$bmi_binned2, labels = new_labels)
table(data$bmi_binned2)

data$gender <- as.character(data$gender)
data$gender[data$gender == ""] <- "missing"
table(data$gender)

data$smoking_status <- as.character(data$smoking_status)
data$smoking_status[data$smoking_status == ""] <- "missing"
table(data$smoking_status)

data$diabetes2 <- as.character(data$diabetes2)
data$diabetes2[data$diabetes2 %in% c("I don't know", "I prefer not to answer")] <- "missing"
data$diabetes2[data$diabetes2 == ""] <- "missing"
table(data$diabetes2)

age_mean <- mean(data$age, na.rm = TRUE)
# Fill missing values in the 'age' column with the mean
data$age[is.na(data$age)] <- age_mean


df <- dummy_cols(data, select_columns = c("gender", "bmi_binned2", "smoking_status", "diabetes2"), remove_selected_columns = TRUE)


### drop nan value of biomarker and air pollution
na_in_Insulin <- sum(is.na(df$Insulin))
print(paste("NA in Insulin:", na_in_Insulin))

df <- df[!is.na(df$Insulin), ]

df$Insulin_v2 <- log(df$Insulin)
df$Insulin_v3 <- (df$Insulin_v2 - mean(df$Insulin_v2)) / sd(df$Insulin_v2)


data_dimensions <- dim(df)
print(data_dimensions)
print(names(df))


#pwqs <- c('UPDASV260','UPDASV092','UPDASV087','UPDASV105','UPDASV346','UPDASV468','UPDASV337','UPDASV281','UPDASV339','UPDASV389',#'UPDASV001','UPDASV375', 'UPDASV384','UPDASV037','UPDASV218','UPDASV073', 'UPDASV286','UPDASV278','UPDASV311','UPDASV212','UPDASV134','UPDASV256','UPDASV089','UPDASV064','UPDASV173', 'UPDASV224','UPDASV435')
#nwqs <- c('UPDASV195', 'UPDASV270', 'UPDASV153', 'UPDASV422')

### filter microbiome with missing over 50%
pwqs <- c('UPDASV073', 'UPDASV224')
nwqs <- c('UPDASV270') 

mixedcor <- c(pwqs, nwqs)

mixedcor_df <- data.frame(Index = mixedcor)


# Read taxonIDname dataframe
taxonIDname <- read_excel("/Users/chelseawu/UChicago/Part-time/BSD/Datasets/taxonIDmappingdict.xlsx")

# Merge mixedcor_df with taxonIDname
merged_df <- mixedcor_df %>%
  inner_join(taxonIDname, by = c("Index" = "newtaxonID"))

# Define the custom function
extract_name <- function(row) {
  attlist <- str_split(row, ",")[[1]]

  if (attlist[length(attlist)] == 'nan') {
    if (attlist[length(attlist) - 1] != 'nan') {
      name <- paste(attlist[length(attlist) - 1], '(unknown genus)' )
    } else if (attlist[length(attlist) - 2] != 'nan') {
      name <- paste(attlist[length(attlist) - 2], '(unknown genus)' )
    } else if (attlist[length(attlist) - 3] != 'nan') {
      name <- paste(attlist[length(attlist) - 3], '(unknown genus)' )
    } else if (attlist[length(attlist) - 4] != 'nan') {
      name <- paste(attlist[length(attlist) - 4], '(unknown genus)' )
    } else {
      name <- paste(attlist[length(attlist) - 5], '(unknown genus)' )
    }
  } else {
    name <- attlist[length(attlist)]
  }

  return(name)
}

# Assuming 'name' is the data frame and 'attribute' is the column
merged_df <- merged_df %>%
  mutate(newname = sapply(attribute, extract_name))
merged_df$newname <- gsub("_", " ", merged_df$newname)

#merged_df$newname[merged_df$Index == "UPDASV186"] <- "Order:Veillonellales Gene:Veillonella"
#merged_df$newname[merged_df$Index == "UPDASV260"] <- "Order:Selenomonadales Gene:Veillonella"



# Convert mixedcor values to new names
mixedcor_with_newnames <- merged_df$newname


name_mapping <- merged_df %>%
  filter(Index %in% colnames(df)) %>%
  select(Index, newname)


# Create a named vector for renaming
rename_vector_ <- setNames(name_mapping$Index, name_mapping$newname)


# Rename the columns in df
df <- df %>%
  rename(!!!rename_vector_)

pwqs_newnames <- name_mapping$newname[name_mapping$Index %in% pwqs]
nwqs_newnames <- name_mapping$newname[name_mapping$Index %in% nwqs]
pwqs <- as.character(pwqs_newnames)
nwqs <- as.character(nwqs_newnames)





formula_str <- "Insulin_v3 ~ pwqs + nwqs + age + gender_Male + bmi_binned2_30.0_inf + bmi_binned2_25.0_30.0 + smoking_status_Current + smoking_status_Former + diabetes2_Yes"


Insulin_results2i <- gwqs(formula = as.formula(formula_str),
                          mix_name = mixedcor_with_newnames, 
                          data = df, 
                          q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                          family = "gaussian", seed = 2024)

summary(Insulin_results2i)


Insulin_summary_model <- summary(Insulin_results2i_l90)
# Extract coefficients
Insulin_coefficients_info <- Insulin_summary_model$coefficients  # This usually contains estimates, std. error, t-value, and p-value
# Get confidence intervals
Insulin_conf_intervals <- confint(Insulin_results2i, level = 0.95)  # Adjust the level if needed
# Base R approach
Insulin_coefficients_df <- data.frame(Insulin_coefficients_info)
Insulin_conf_intervals_df <- data.frame(Insulin_conf_intervals)
# Naming the columns correctly
names(Insulin_conf_intervals_df) <- c("2.5 %", "97.5 %")
# Combining the estimates and confidence intervals
Insulin_final_df <- cbind(Insulin_coefficients_df, Insulin_conf_intervals_df)
# If you only want certain columns (Estimate, Std. Error, 2.5 %, 97.5 %)
Insulin_final_df <- Insulin_final_df[, c("Estimate", "Std..Error", "2.5 %", "97.5 %")]
print(Insulin_final_df)


###### Insulin Step 2
# we run the model setting the penalization term equal to 90
Insulin_results2i_l90 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                               family = "gaussian", seed = 2024, lambda = 90)

# we run the model setting the penalization term equal to 900
Insulin_results2i_l900 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                               family = "gaussian", seed = 2024, lambda = 900)

# we run the model setting the penalization term equal to 900
Insulin_results2i_l9000 <- gwqs(formula = as.formula(formula_str), 
                               mix_name = mixedcor_with_newnames, data = df, 
                               q = 10, validation = 0, b = 100, b1_pos = TRUE, rh=2,
                               family = "gaussian", seed = 2024, lambda = 9000)

Insulin_lambda_AIC_2i <- data.frame(lambda = c(0, 90, 900, 9000),
                            AIC = c(Insulin_results2i$fit$aic, Insulin_results2i_l90$fit$aic, 
                                    Insulin_results2i_l900$fit$aic, Insulin_results2i_l9000$fit$aic))

print(kable(Insulin_lambda_AIC_2i) %>% kable_styling())


# Save the model
save(Insulin_results2i, file = "/Users/chelseawu/UChicago/Part-time/BSD/result/202506new/microbiome_filtermissingover50/Insulin_results2i.RData")
save(Insulin_results2i_l90, file = "/Users/chelseawu/UChicago/Part-time/BSD/result/202506new/microbiome_filtermissingover50/Insulin_results2i_l90.RData")
save(Insulin_results2i_l900, file = "/Users/chelseawu/UChicago/Part-time/BSD/result/202506new/microbiome_filtermissingover50/Insulin_results2i_l900.RData")
save(Insulin_results2i_l9000, file = "/Users/chelseawu/UChicago/Part-time/BSD/result/202506new/microbiome_filtermissingover50/Insulin_results2i_l9000.RData")
# Later, you can load the model
#load("Insulin_results2i.RData")
# Check the loaded model
#print(Insulin_results2i)

```



```{r}
library(ggplot2)
### PLOT 

Ghrelin_box <- gwqs_boxplot(Ghrelin_results2i) +
  labs(x = NULL, y=NULL, title = "Ghrelin conjunct infulence") +
  theme(plot.title = element_text(hjust = 0.5))
 # (axis.text.x = element_text(size = 4, angle = 45, hjust = 1)))
print(Ghrelin_box)


Resistin_box <- gwqs_boxplot(Resistin_results2i) +
  labs(x = NULL, y=NULL, title = "Resistin conjunct infulence") +
  theme(plot.title = element_text(hjust = 0.5))
 # (axis.text.x = element_text(size = 4, angle = 45, hjust = 1)))
print(Resistin_box)


Insulin_box <- gwqs_boxplot(Insulin_results2i) +
  labs(x = NULL, y=NULL, title = "Insulin conjunct infulence") +
  theme(plot.title = element_text(hjust = 0.5))
 # (axis.text.x = element_text(size = 4, angle = 45, hjust = 1)))
print(Insulin_box)

```





```{r}
##### Final plot for mixture analysis Part 1

library(ggplot2)
library(reshape2)

load("C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Insulin_results2i.RData")
load("C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Resistin_results2i.RData")
load("C:\\Users\\yuqingw1\\Workfolder\\result\\Mixture_Model\\Ghrelin_results2i.RData")


# Function to identify selected microbiomes using wmatpos and wmatneg
selected_microbiomes <- function(model, threshold) {
  # Melt the weight matrices
  melted_wmatpos <- melt(model$wmat$wmatpos, varnames = c("rh", "mix_name"))
  melted_wmatneg <- melt(model$wmat$wmatneg, varnames = c("rh", "mix_name"))
  
  # Identify significant microbiomes
  positive_microbiomes <- melted_wmatpos[melted_wmatpos$value > threshold, "mix_name"]
  negative_microbiomes <- melted_wmatneg[melted_wmatneg$value > threshold, "mix_name"]
  
  # Combine and return unique microbiomes
  unique(c(positive_microbiomes, negative_microbiomes))
}

# Define thresholds for all models
threshold_resistin <- 1 / length(Resistin_results2i$mix_name)
threshold_insulin <- 1 / length(Insulin_results2i$mix_name)
#threshold_ghrelin <- 1 / length(Ghrelin_results2i$mix_name)

print(paste("Threshold Resistin:", threshold_resistin))
print(paste("Threshold Insulin:", threshold_insulin))
#print(paste("Threshold Ghrelin:", threshold_ghrelin))

# Calculate the mean threshold
mean_threshold <- mean(c(threshold_resistin, threshold_insulin))
print(paste("Mean Threshold:", mean_threshold))

# Identify selected microbiomes for Resistin and Insulin
selected_resistin <- selected_microbiomes(Resistin_results2i, threshold_resistin)
selected_insulin <- selected_microbiomes(Insulin_results2i, threshold_insulin)

# Combine significant microbiomes from Resistin and Insulin
selected_microbiomes_list <- unique(c(selected_resistin, selected_insulin))
print("Selected Microbiomes (combined from Resistin and Insulin):")
print(selected_microbiomes_list)

# Melt the weight matrices for Resistin, Insulin, and Ghrelin
melted_wmatpos_resistin <- melt(Resistin_results2i$wmat$wmatpos, varnames = c("rh", "mix_name"))
melted_wmatpos_resistin$Biomarker <- "Resistin"
melted_wmatpos_resistin$Direction <- "Positive"

melted_wmatneg_resistin <- melt(Resistin_results2i$wmat$wmatneg, varnames = c("rh", "mix_name"))
melted_wmatneg_resistin$Biomarker <- "Resistin"
melted_wmatneg_resistin$Direction <- "Negative"

melted_wmatpos_insulin <- melt(Insulin_results2i$wmat$wmatpos, varnames = c("rh", "mix_name"))
melted_wmatpos_insulin$Biomarker <- "Insulin"
melted_wmatpos_insulin$Direction <- "Positive"

melted_wmatneg_insulin <- melt(Insulin_results2i$wmat$wmatneg, varnames = c("rh", "mix_name"))
melted_wmatneg_insulin$Biomarker <- "Insulin"
melted_wmatneg_insulin$Direction <- "Negative"

melted_wmatpos_ghrelin <- melt(Ghrelin_results2i$wmat$wmatpos, varnames = c("rh", "mix_name"))
melted_wmatpos_ghrelin$Biomarker <- "Ghrelin"
melted_wmatpos_ghrelin$Direction <- "Positive"

melted_wmatneg_ghrelin <- melt(Ghrelin_results2i$wmat$wmatneg, varnames = c("rh", "mix_name"))
melted_wmatneg_ghrelin$Biomarker <- "Ghrelin"
melted_wmatneg_ghrelin$Direction <- "Negative"

# Combine the melted data
melted_data <- rbind(melted_wmatpos_resistin, melted_wmatneg_resistin, melted_wmatpos_insulin, melted_wmatneg_insulin, melted_wmatpos_ghrelin, melted_wmatneg_ghrelin)

# Filter the melted data to include only the selected microbiomes
melted_data <- melted_data[melted_data$mix_name %in% selected_microbiomes_list, ]
if (nrow(melted_data) == 0) {
  stop("No matching microbiomes found in the data after filtering.")
}

# Reorder the Biomarker factor levels
melted_data$Biomarker <- factor(melted_data$Biomarker, levels = c("Ghrelin", "Resistin", "Insulin"))


# Create the combined box plot with a red dashed horizontal line at the mean threshold
box_plot <- ggplot(melted_data, aes(x = mix_name, y = value, fill = Biomarker)) +
  geom_boxplot(outlier.shape = NA, color = "black") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
  strip.text = element_text(size = 16, face = "bold")  # Adjust facet label font size and style
  ) +
  ylab("Weight") +
  xlab("") +     
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, aes(color = Biomarker), position = position_dodge(width = 0.75)) +
  geom_jitter(alpha = 0.3, aes(color = Biomarker), position = position_dodge(width = 0.75)) +
  geom_hline(yintercept = mean_threshold, linetype = "dashed", color = "red") + # Add red dashed line for mean threshold
  scale_fill_manual(values = c("Resistin" = "blue", "Insulin" = "green", "Ghrelin" = "orange")) +
  scale_color_manual(values = c("Resistin" = "blue4", "Insulin" = "green4", "Ghrelin" = "orange4")) +
  labs(title = "A)", y = "Weight") +
  facet_wrap(~Direction, ncol = 1, scales = "free_y") # Facet wrap to separate Positive and Negative

print(box_plot)



```

```{r}
##### Final plot for mixture analysis Part 2
# Convert to trfs format
# Read the saved PNG image
image_path <- "C:\\Users\\yuqingw1\\Workfolder\\Figure\\Mixture_plot_new.png"
image_data <- readBin(image_path, what = "raw", n = file.info(image_path)$size)

# Define TRFS metadata
metadata <- list(
  Format = "PNG",
  Resolution = "1260x1260",
  Description = "Mixture Analysis using WQS for different biomarker and microbiome"
)

# Define the TRFS output path
trfs_path <- "C:\\Users\\yuqingw1\\Workfolder\\Figure\\Mixture_plot_new.trfs"

# Write the TRFS file
con <- file(trfs_path, "wb")
writeLines("[HEADER]", con)

# Add metadata to the TRFS file
for (key in names(metadata)) {
  writeLines(paste0(key, ": ", metadata[[key]]), con)
}

writeLines("[DATA]", con)

# Write binary image data
writeBin(image_data, con)

writeLines("[END]", con)
close(con)

cat("TRFS file saved as '", trfs_path, "'\n", sep = "")


```


```{r}
##### Final plot for mixture analysis Part 3
# Add table then convert trfs format

library(magick)

# Load the two PNG plots
plot1 <- image_read("C:\\Users\\yuqingw1\\Workfolder\\Figure\\Mixture_plot_new.png")
plot2 <- image_read("C:\\Users\\yuqingw1\\Workfolder\\Figure\\MixtureTable.png")

# Zoom in by cropping the image
#plot2_zoomed <- image_scale(plot2, "200%")  # Scale the image to 120% of its original size
plot2_centered <- image_extent(plot2, geometry = "1200x200", gravity = "center", color = "white")


# Combine the plots vertically
combined_plot <- image_append(c(plot1, plot2), stack = TRUE)

# Save the combined plot as a PNG
output_path <- "C:\\Users\\yuqingw1\\Workfolder\\Figure\\Mixture_combined_Table.png"
image_write(combined_plot, output_path)
cat("Combined plot saved as:", output_path, "\n")


# Read the combined PNG image
combined_image_data <- readBin(output_path, what = "raw", n = file.info(output_path)$size)

# Define TRFS metadata
metadata <- list(
  Description = "Integrated figure combining two plots (upper and lower).",
  Format = "PNG",
  Resolution = "1500x2000"  # Update this based on the actual dimensions of your combined plot
)

# Define TRFS file path
trfs_path <- "C:\\Users\\yuqingw1\\Workfolder\\Figure\\Mixture_combined_Table.trfs"

# Write the TRFS file
con <- file(trfs_path, "wb")
writeLines("[HEADER]", con)

# Add metadata
for (key in names(metadata)) {
  writeLines(paste0(key, ": ", metadata[[key]]), con)
}

writeLines("[DATA]", con)

# Write binary image data
writeBin(combined_image_data, con)

writeLines("[END]", con)
close(con)

cat("TRFS file saved as:", trfs_path, "\n")



```







```{r} ### discard
library(ggplot2)
library(knitr)
library(kableExtra)
library(data.table)
library(fastDummies)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggtext) 
library(gridExtra)  # Load gridExtra package for plot resizing

# Load data
data <- fread('/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/result/plotdata1.csv')
data <- data[1:80, ]

long_data <- melt(data, id.vars = "Index", variable.name = "Metric", value.name = "Coefficient")
long_data$normCoefficient <- scales::rescale(long_data$Coefficient, to = c(-1, 1))

# Define background colors for each metric with background color blocks
metrics_labels <- c(
  "PM2.5" = "<span style='background-color: bisque2; color: black; padding: 2px 5px; border-radius: 4px;'>PM2.5</span>",
  "Ghrelin" = "<span style='background-color: cadetblue1; color: black; padding: 2px 5px; border-radius: 4px;'>Ghrelin</span>",
  "Leptin" = "<span style='background-color: cadetblue1; color: black; padding: 2px 5px; border-radius: 4px;'>Leptin</span>",
  "Insulin" = "<span style='background-color: cadetblue1; color: black; padding: 2px 5px; border-radius: 4px;'>Insulin</span>",
  "Resistin" = "<span style='background-color: cadetblue1; color: black; padding: 2px 5px; border-radius: 4px;'>Resistin</span>"
)

# Update Metric column in long_data for plot labels
long_data$Metric_label <- sapply(long_data$Metric, function(x) metrics_labels[x])

# Create the heatmap with formatted x-axis labels
plot <- ggplot(long_data, aes(x = Metric_label, y = Index, fill = normCoefficient)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "darkslategray3", high = "coral", midpoint = 0, space = "Lab", 
    name = "Coefficient Sign"
  ) +
  labs(
    title = "Heatmap of Microbiome Coefficients",
    subtitle = "Intensity indicates magnitude; darker shades are more negative, lighter shades are more positive.",
    x = "Metrics",
    y = "Microbiome"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_markdown(angle = 45, hjust = 1)  # Combined HTML formatting and positioning text
  )

# Adjusting the plot size within the R environment for a better view
g <- ggplot_gtable(ggplot_build(plot))
g$widths <- grid::unit.pmax(g$widths, grid::unit(1, "in"))
grid::grid.draw(g)
#grid.newpage(width = unit(12, "cm"), height = unit(8, "cm"))  # Set plot width and height

# Print the plot
print(plot)

# Save the plot - specify the dimensions and resolution
#ggsave("/Users/yuqingwu/UChicago_MSDS/Part-time/BSD/result/long_heatmap.png", plot = plot, width = 12, height = 100, dpi = 150, units = "in", limitsize = FALSE)
```








